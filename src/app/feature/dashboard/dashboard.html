<div class="flex flex-col h-screen bg-gray-100">
  <!-- Topbar -->
  <header class="flex items-center justify-between px-4 py-3 bg-white shadow relative z-10">
    <div class="flex items-center gap-3">
      <img src="/assets/quick-chat.png" alt="QuickChat" class="w-12 h-12 md:w-14 md:h-14 drop-shadow-sm" />
      <div class="hidden sm:block">
        <div class="text-lg font-semibold leading-5">QuickChat</div>
        <div class="text-[11px] text-gray-500 -mt-0.5">chat.therama.dev</div>
      </div>
      <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-gray-50 text-gray-700 border ml-2"
            [class.bg-green-100]="realtimeConnected()" [class.text-green-700]="realtimeConnected()"
            [class.bg-gray-100]="!realtimeConnected()" [class.text-gray-600]="!realtimeConnected()">
        {{ realtimeConnected() ? 'Realtime: connected' : 'Realtime: offline' }}
      </span>
    </div>
    <div class="flex items-center gap-3 text-sm relative">
      <!-- Avatar button -->
      <button type="button" (click)="toggleMenu()" class="flex items-center gap-2">
        <ng-container *ngIf="profileAvatarUrl(); else initials">
          <img [src]="profileAvatarUrl()" class="w-9 h-9 rounded-full object-cover ring-1 ring-gray-200" alt="avatar" />
        </ng-container>
        <ng-template #initials>
          <div class="w-9 h-9 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold ring-1 ring-blue-300">
            {{ avatarInitials() }}
          </div>
        </ng-template>
      </button>

      <!-- Dropdown menu -->
      <div *ngIf="showMenu()" class="absolute right-0 top-12 w-48 bg-white border rounded shadow-md py-1">
        <button class="w-full text-left px-3 py-2 hover:bg-gray-50" (click)="openProfile()">My profile</button>
        <button class="w-full text-left px-3 py-2 hover:bg-gray-50" (click)="openWhatsNew()">Whatâ€™s new</button>
        <button class="w-full text-left px-3 py-2 hover:bg-gray-50 text-red-600" (click)="logout()" [disabled]="loggingOut()">
          {{ loggingOut() ? 'Logging outâ€¦' : 'Logout' }}
        </button>
      </div>
    </div>
  </header>

  <!-- Content area -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Friends sidebar -->
    <aside class="w-64 bg-white border-r overflow-y-auto">
      <div class="p-3 border-b font-medium text-gray-700">Friends</div>

      <!-- Email search to start a chat -->
      <div class="p-3 border-b space-y-2">
        <input
          type="email"
          class="w-full border rounded px-3 py-2 text-sm"
          placeholder="Search by email"
          [value]="searchEmail()"
          (input)="onSearchEmail($event)"
        />
        <button
          class="w-full bg-blue-600 text-white text-sm py-2 rounded hover:bg-blue-700 disabled:opacity-60"
          type="button"
          (click)="startChatByEmail()"
          [disabled]="searching()"
        >
          {{ searching() ? 'Searching...' : 'Start chat' }}
        </button>
        <div class="text-xs text-red-600" *ngIf="searchError()">{{ searchError() }}</div>
      </div>
      <ul>
        <li *ngFor="let f of friends()" (click)="selectFriend(f.id)"
            class="px-4 py-3 cursor-pointer hover:bg-gray-50 flex items-center justify-between gap-3"
            [class.bg-blue-50]="selectedFriendId() === f.id">
          <div class="flex items-center gap-2 min-w-0 flex-1">
            <img *ngIf="f.avatar_url" [src]="f.avatar_url" alt="avatar"
                 class="w-7 h-7 rounded-full object-cover" />
            <div class="min-w-0">
              <div class="truncate text-sm">{{ f.name || f.email }}</div>
              <div class="text-[11px] text-gray-500 truncate">
                <ng-container *ngIf="f.last_message_text; else noMsg">
                  <span class="opacity-70" *ngIf="f.last_message_from_me">You: </span>{{ f.last_message_text }}
                </ng-container>
                <ng-template #noMsg>
                  {{ f.email }}
                </ng-template>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="text-[10px] text-gray-400" *ngIf="f.last_message_at as t">{{ t | date:'shortTime' }}</div>
            <span class="w-2 h-2 rounded-full"
                  [class.bg-green-500]="onlineIds().includes(f.id)"
                  [class.bg-gray-300]="!onlineIds().includes(f.id)"></span>
          </div>
        </li>
      </ul>
    </aside>

    <!-- Chat area -->
    <main class="flex-1 flex flex-col">
      <!-- Chat header -->
      <div class="px-4 py-3 bg-white border-b flex items-center gap-3">
        <ng-container *ngIf="getFriend(selectedFriendId()) as f">
          <img *ngIf="f.avatar_url" [src]="f.avatar_url" class="w-8 h-8 rounded-full object-cover" />
        </ng-container>
        <div class="flex items-center gap-2">
          <h2 class="font-medium text-gray-800">{{ friendName(selectedFriendId()) }}</h2>
          <span class="w-2 h-2 rounded-full"
                [class.bg-green-500]="onlineIds().includes(selectedFriendId() || '')"
                [class.bg-gray-300]="!onlineIds().includes(selectedFriendId() || '')"></span>
        </div>
      </div>

      <!-- Messages list -->
      <div class="flex-1 overflow-y-auto p-4 space-y-2">
        <div *ngFor="let m of messages()" class="flex" [class.justify-end]="m.from === 'me'">
          <div [class.bg-blue-600]="m.from === 'me'" [class.text-white]="m.from === 'me'"
               [class.bg-white]="m.from === 'them'" [class.text-gray-800]="m.from === 'them'"
               class="px-3 py-2 rounded-lg shadow max-w-[70%]">
            <!-- Attachment rendering -->
            <ng-container *ngIf="m.attachment as a; else textOnly">
              <div class="space-y-2">
                <ng-container *ngIf="a.url; else urlLoading">
                  <a *ngIf="!isImageMime(a.mime)" [href]="a.url" target="_blank" rel="noopener" class="underline break-all">
                    {{ a.name }}
                  </a>
                  <img *ngIf="isImageMime(a.mime)" [src]="a.url" alt="attachment" class="rounded max-h-64 object-contain" (error)="onAttachmentImageError(m.id!)" />
                </ng-container>
                <ng-template #urlLoading>
                  <div class="text-xs text-gray-500">Loading attachmentâ€¦</div>
                </ng-template>
                <p *ngIf="a.text" class="whitespace-pre-line">{{ a.text }}</p>
              </div>
            </ng-container>
            <ng-template #textOnly>
              <p class="whitespace-pre-line">{{ m.text }}</p>
            </ng-template>
            <div class="text-[11px] opacity-70 mt-1">{{ m.at | date:'shortTime' }}</div>
          </div>
        </div>
      </div>

      <!-- Composer with Drop Zone -->
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()"
            class="p-3 bg-white border-t space-y-2"
            (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
        <div class="flex items-center gap-2 border-2 border-dashed rounded p-2"
             [class.border-blue-400]="dragging()" [class.border-gray-200]="!dragging()"
             [class.bg-blue-50]="dragging()">
          <button type="button" (click)="showEmoji.set(!showEmoji())" class="px-2 py-2 rounded border text-sm">
            ðŸ˜Š
          </button>
          <label class="px-2 py-2 rounded border text-sm cursor-pointer">
            ðŸ“Ž
            <input type="file" (change)="onFileSelected($event)" [disabled]="uploading()" class="hidden" [attr.accept]="ACCEPTED_MIME_LIST.join(',')" />
          </label>
          <span class="text-xs text-gray-500" *ngIf="uploading()">Uploading...</span>
          <input type="text" formControlName="text" placeholder="Type a message or caption"
                 class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200" />
          <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                  [disabled]="messageForm.invalid">Send</button>
        </div>
        <!-- Drop hint -->
        <div *ngIf="dragging()" class="text-xs text-blue-700">Drop a file anywhere in this box to upload</div>
        <!-- Upload progress (determinate) -->
        <div *ngIf="uploading()" class="w-full">
          <div class="w-full h-2 bg-gray-100 rounded">
            <div class="h-2 bg-blue-500 rounded" [style.width.%]="uploadProgress()"></div>
          </div>
          <div class="text-[11px] text-gray-500 mt-1">Uploading {{ uploadProgress() }}%</div>
        </div>
        <!-- Validation error for uploads -->
        <div *ngIf="uploadError()" class="text-xs text-red-600" role="alert" aria-live="polite">{{ uploadError() }}</div>

        <!-- Full emoji picker -->
        <app-emoji-picker
          *ngIf="showEmoji()"
          (emojiSelect)="onEmojiSelected($event)"
          (closed)="onEmojiClosed()"
        ></app-emoji-picker>
      </form>
    </main>
  </div>
  <app-footer></app-footer>

  <!-- Profile Dialog -->
  <div *ngIf="showProfileDialog()" class="fixed inset-0 bg-black/40 flex items-center justify-center z-20">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-5">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">My profile</h3>
        <button class="text-gray-500" (click)="closeDialogs()">âœ•</button>
      </div>
      <div class="flex flex-col items-center gap-4">
        <!-- Cropper mode -->
        <div *ngIf="cropping(); else avatarPreview" class="w-full">
          <image-cropper
            [imageChangedEvent]="imageChangedEvent"
            [maintainAspectRatio]="true"
            [aspectRatio]="1/1"
            [roundCropper]="true"
            format="png"
            (imageCropped)="onImageCropped($event)"
            (imageLoaded)="onImageLoaded()"
            (cropperReady)="onCropperReady()"
            (loadImageFailed)="onLoadImageFailed()"
          ></image-cropper>
          <div class="text-xs text-gray-500 mt-1">Drag to adjust the crop, then click Save.</div>
        </div>
        <ng-template #avatarPreview>
          <ng-container *ngIf="profileAvatarUrl(); else initPreview">
            <img [src]="profileAvatarUrl()" class="w-24 h-24 rounded-full object-cover ring-2 ring-blue-200" alt="avatar" />
          </ng-container>
          <ng-template #initPreview>
            <div class="w-24 h-24 rounded-full bg-blue-600 text-white flex items-center justify-center text-2xl font-bold ring-2 ring-blue-300">
              {{ avatarInitials() }}
            </div>
          </ng-template>
          <label class="px-3 py-1.5 border rounded cursor-pointer text-sm mt-2 inline-block">Change photo
            <input type="file" class="hidden" accept="image/*" (change)="onAvatarFileChange($event)" />
          </label>
        </ng-template>
        <div class="w-full">
          <label class="block text-sm text-gray-600 mb-1">Name</label>
          <input type="text" class="w-full border rounded px-3 py-2" [value]="profileName()" (input)="onProfileNameInput($event)" placeholder="Your name" />
          <div class="text-xs text-gray-500 mt-1">Name is required and cannot be empty.</div>
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button class="px-3 py-1.5 border rounded" (click)="closeDialogs()">Cancel</button>
        <button class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700" (click)="saveProfileDialog()">Save</button>
      </div>
    </div>
  </div>

  <!-- Whatâ€™s New Dialog -->
  <div *ngIf="showWhatsNewDialog()" class="fixed inset-0 bg-black/40 flex items-center justify-center z-20">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-5 max-h-[80vh] overflow-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Whatâ€™s new</h3>
        <button class="text-gray-500" (click)="closeDialogs()">âœ•</button>
      </div>
      <pre class="whitespace-pre-wrap text-sm text-gray-800">{{ changelog() }}</pre>
    </div>
  </div>
</div>