<div class="flex flex-col h-screen bg-gray-100">
  <!-- Topbar -->
  <header class="flex items-center justify-between px-4 py-3 bg-white shadow">
    <div class="flex items-center gap-3">
      <img src="/assets/logo.png" alt="Logo" class="w-8 h-8" onerror="this.style.display='none'" />
      <h1 class="text-lg font-semibold">Chat App</h1>
      <span class="ml-2 text-xs px-2 py-0.5 rounded-full"
            [class.bg-green-100]="realtimeConnected()" [class.text-green-700]="realtimeConnected()"
            [class.bg-gray-100]="!realtimeConnected()" [class.text-gray-600]="!realtimeConnected()">
        {{ realtimeConnected() ? 'Realtime: connected' : 'Realtime: offline' }}
      </span>
    </div>
    <div class="flex items-center gap-3 text-sm">
      <span class="text-gray-600" *ngIf="user()">{{ user()?.['name'] | titlecase }}</span>
      <button (click)="logout()" [disabled]="loggingOut()"
              class="px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700 disabled:opacity-60">
        {{ loggingOut() ? 'Logging out...' : 'Logout' }}
      </button>
    </div>
  </header>

  <!-- Content area -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Friends sidebar -->
    <aside class="w-64 bg-white border-r overflow-y-auto">
      <div class="p-3 border-b font-medium text-gray-700">Friends</div>

      <!-- Email search to start a chat -->
      <div class="p-3 border-b space-y-2">
        <input
          type="email"
          class="w-full border rounded px-3 py-2 text-sm"
          placeholder="Search by email"
          [value]="searchEmail()"
          (input)="onSearchEmail($event)"
        />
        <button
          class="w-full bg-blue-600 text-white text-sm py-2 rounded hover:bg-blue-700 disabled:opacity-60"
          type="button"
          (click)="startChatByEmail()"
          [disabled]="searching()"
        >
          {{ searching() ? 'Searching...' : 'Start chat' }}
        </button>
        <div class="text-xs text-red-600" *ngIf="searchError()">{{ searchError() }}</div>
      </div>
      <ul>
        <li *ngFor="let f of friends()" (click)="selectFriend(f.id)"
            class="px-4 py-3 cursor-pointer hover:bg-gray-50 flex items-center justify-between"
            [class.bg-blue-50]="selectedFriendId() === f.id">
          <div class="flex items-center gap-2 min-w-0">
            <img *ngIf="f.avatar_url" [src]="f.avatar_url" alt="avatar"
                 class="w-7 h-7 rounded-full object-cover" />
            <div class="min-w-0">
              <div class="truncate text-sm">{{ f.name || f.email }}</div>
              <div class="text-[10px] text-gray-500 truncate">{{ f.email }}</div>
            </div>
          </div>
          <span class="w-2 h-2 rounded-full"
                [class.bg-green-500]="onlineIds().includes(f.id)"
                [class.bg-gray-300]="!onlineIds().includes(f.id)"></span>
        </li>
      </ul>
    </aside>

    <!-- Chat area -->
    <main class="flex-1 flex flex-col">
      <!-- Chat header -->
      <div class="px-4 py-3 bg-white border-b flex items-center gap-3">
        <ng-container *ngIf="getFriend(selectedFriendId()) as f">
          <img *ngIf="f.avatar_url" [src]="f.avatar_url" class="w-8 h-8 rounded-full object-cover" />
        </ng-container>
        <div class="flex items-center gap-2">
          <h2 class="font-medium text-gray-800">{{ friendName(selectedFriendId()) }}</h2>
          <span class="w-2 h-2 rounded-full"
                [class.bg-green-500]="onlineIds().includes(selectedFriendId() || '')"
                [class.bg-gray-300]="!onlineIds().includes(selectedFriendId() || '')"></span>
        </div>
      </div>

      <!-- Messages list -->
      <div class="flex-1 overflow-y-auto p-4 space-y-2">
        <div *ngFor="let m of messages()" class="flex" [class.justify-end]="m.from === 'me'">
          <div [class.bg-blue-600]="m.from === 'me'" [class.text-white]="m.from === 'me'"
               [class.bg-white]="m.from === 'them'" [class.text-gray-800]="m.from === 'them'"
               class="px-3 py-2 rounded-lg shadow max-w-[70%]">
            <p class="whitespace-pre-line">{{ m.text }}</p>
            <div class="text-[11px] opacity-70 mt-1">{{ m.at | date:'shortTime' }}</div>
          </div>
        </div>
      </div>

      <!-- Composer -->
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="p-3 bg-white border-t flex gap-2">
        <input type="text" formControlName="text" placeholder="Type a message"
               class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200" />
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
                [disabled]="messageForm.invalid">Send</button>
      </form>
    </main>
  </div>
</div>